# QOTD (Question of the Day)

Minimal monorepo MVP for a Question of the Day site with AI grading.

## Prereqs

- Go 1.22+
- Node.js 18+
- Docker (optional, recommended for DB + API)
- An OpenAI API key

## Setup

1. Copy envs:

   cp .env.example .env

2. Start services (pick one):

   - With Docker Compose (no local psql needed; migrations auto-run):

     docker compose up --build

     API on http://localhost:8080

   - Local (without Docker):
     - Ensure Postgres has `pgvector` installed (or run the compose `db` service)
     - Set `DATABASE_URL` (see `.env.example`)
     - Run migrations: `make migrate-up`
     - Start API: `make run-api` (http://localhost:8080)

3. Run the Web app:

   cd web && npm i && npm run dev

   Open http://localhost:3000/today

## Migrations

- Single source of truth: `api/migrate.sh` (used by Makefile and container entrypoint).
- Makefile targets:
  - Up: `make migrate-up`
  - Down: `make migrate-down`
- Direct script usage:
  - Up: `DATABASE_URL=... sh api/migrate.sh up`
  - Down: `DATABASE_URL=... sh api/migrate.sh down`
- No-install alternatives:
  - API container: `docker compose run --rm api /app/migrate.sh up`
  - DB container: `docker compose exec -T db psql -U postgres -d qotd -v ON_ERROR_STOP=1 -f /dev/stdin < db/migrations/001_init.sql`

## Environment Variables

- `DATABASE_URL` (API/migrations):
  - Compose: injected automatically for the API
  - Local: required (e.g., `postgres://postgres:postgres@localhost:5432/qotd?sslmode=disable`)
- `OPENAI_API_KEY` (API): required for grading/generation
- `OPENAI_EMBED_MODEL` (API): default `text-embedding-3-small`
- `OPENAI_GRADE_MODEL` (API): default `gpt-4o-mini`
- `CRON_KEY` (API): required to call `/v1/admin/generate-today`
- `NEXT_PUBLIC_API_BASE` (Web): default `http://localhost:8080`

### Do I need psql locally?

- Not if you use Docker Compose (entrypoint runs migrations automatically).
- If running migrations locally, install the Postgres client (`psql`). Recommended: version 16 (15+ works).
  - Windows: https://www.postgresql.org/download/windows/
  - macOS: https://www.postgresql.org/download/macosx/ (or `brew install postgresql@16`)
  - Linux: https://www.postgresql.org/download/

## Cron (generate daily question)

Protected by `X-CRON-KEY`. Example:

curl -X POST "http://localhost:8080/v1/admin/generate-today" \
  -H "X-CRON-KEY: $CRON_KEY"

On success, the response now also includes acceptable answer variants generated by the LLM (stored with the question):

{
  "id": "…",
  "title": "…",
  "text": "…",
  "topic": "…",
  "created_at": "…",
  "similarity": "0.123",
  "choices": ["Pacific Ocean", "Pacific", "Pacific Ocean (largest)"]
}

See `.github/workflows/cron.yml` for a GitHub Action that can hit this daily. Set `API_URL` and `CRON_KEY` as encrypted repository secrets.

## Project Layout

qotd/
  api/        Go backend (chi + pgx)
  web/        Next.js frontend (App Router)
  db/         SQL migrations

## Notes

- Models are configurable via env: `OPENAI_EMBED_MODEL` (default `text-embedding-3-small`), `OPENAI_GRADE_MODEL` (default `gpt-4o-mini`).
- The generate flow normalizes + hashes text for duplicates, embeds for vector similarity, and retries up to 5 times.
- Duplicate protection rejects questions whose text embedding is too similar (cosine ≥ 0.6) or whose normalized answer choices overlap with existing ones.
